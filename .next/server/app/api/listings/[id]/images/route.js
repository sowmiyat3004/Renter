"use strict";(()=>{var e={};e.id=18,e.ids=[18],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},96068:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>v,patchFetch:()=>I,requestAsyncStorage:()=>y,routeModule:()=>h,serverHooks:()=>j,staticGenerationAsyncStorage:()=>q});var t={};s.r(t),s.d(t,{DELETE:()=>f,POST:()=>x});var i=s(49303),a=s(88716),o=s(60670),n=s(87070),u=s(75571),l=s(90455),d=s(72331);let c=require("fs/promises");var p=s(55315);let g=require("fs"),m=require("sharp");var w=s.n(m);async function x(e,{params:r}){try{let s=await (0,u.getServerSession)(l.L);if(!s?.user)return n.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let t=r.id;if(!await d._.listing.findFirst({where:{id:t,ownerId:s.user.id}}))return n.NextResponse.json({success:!1,error:"Listing not found or unauthorized"},{status:404});let i=(await e.formData()).getAll("images");if(!i||0===i.length)return n.NextResponse.json({success:!1,error:"No images provided"},{status:400});let a=await d._.listingImage.count({where:{listingId:t}});if(a+i.length>10)return n.NextResponse.json({success:!1,error:"Maximum 10 images allowed per listing"},{status:400});let o=[];for(let e of i){if(!e.type.startsWith("image/"))return n.NextResponse.json({success:!1,error:"Only image files are allowed"},{status:400});if(e.size>1048576)return n.NextResponse.json({success:!1,error:"Image size must be less than 1MB"},{status:400});let r=(0,p.join)(process.cwd(),"public","uploads",t);(0,g.existsSync)(r)||await (0,c.mkdir)(r,{recursive:!0});let s=Date.now(),i=Math.random().toString(36).substring(2,15),u=e.name.split(".").pop(),l=`${s}_${i}.${u}`,m=(0,p.join)(r,l),x=await e.arrayBuffer(),f=Buffer.from(x),h=await w()(f).resize(1200,1200,{fit:"inside",withoutEnlargement:!0}).jpeg({quality:85}).toBuffer();await (0,c.writeFile)(m,h);let y=await w()(h).metadata(),q=`/uploads/${t}/${l}`,j=0===a,v=await d._.listingImage.create({data:{listingId:t,url:q,isPrimary:j,width:y.width,height:y.height}});o.push(v)}return n.NextResponse.json({success:!0,data:o,message:"Images uploaded successfully"})}catch(e){return console.error("Image upload error:",e),n.NextResponse.json({success:!1,error:"Failed to upload images"},{status:500})}}async function f(e,{params:r}){try{let s=await (0,u.getServerSession)(l.L);if(!s?.user)return n.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let t=r.id,{searchParams:i}=new URL(e.url),a=i.get("imageId");if(!a)return n.NextResponse.json({success:!1,error:"Image ID is required"},{status:400});if(!await d._.listing.findFirst({where:{id:t,ownerId:s.user.id}}))return n.NextResponse.json({success:!1,error:"Listing not found or unauthorized"},{status:404});if(!await d._.listingImage.findFirst({where:{id:a,listingId:t}}))return n.NextResponse.json({success:!1,error:"Image not found"},{status:404});return await d._.listingImage.delete({where:{id:a}}),n.NextResponse.json({success:!0,message:"Image deleted successfully"})}catch(e){return console.error("Image delete error:",e),n.NextResponse.json({success:!1,error:"Failed to delete image"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/listings/[id]/images/route",pathname:"/api/listings/[id]/images",filename:"route",bundlePath:"app/api/listings/[id]/images/route"},resolvedPagePath:"/Users/sowmiya/Renter/Renter/app/api/listings/[id]/images/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:y,staticGenerationAsyncStorage:q,serverHooks:j}=h,v="/api/listings/[id]/images/route";function I(){return(0,o.patchFetch)({serverHooks:j,staticGenerationAsyncStorage:q})}},90455:(e,r,s)=>{s.d(r,{L:()=>u});var t=s(53797),i=s(77234),a=s(42023),o=s.n(a),n=s(72331);let u={providers:[(0,i.Z)({clientId:"your-google-client-id",clientSecret:"your-google-client-secret"}),(0,t.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let r=await n._.user.findUnique({where:{email:e.email}});if(!r||!r.passwordHash||!await o().compare(e.password,r.passwordHash))return null;return{id:r.id,email:r.email,name:r.name,role:r.role}}catch(e){return console.error("Auth error:",e),null}}})],callbacks:{async signIn({user:e,account:r,profile:s}){if(r?.provider==="google")try{let s=await n._.user.findUnique({where:{email:e.email}});s?s.googleId||await n._.user.update({where:{id:s.id},data:{googleId:r.providerAccountId}}):await n._.user.create({data:{name:e.name,email:e.email,googleId:r.providerAccountId,role:"USER",emailVerified:new Date}})}catch(e){return console.error("Error during Google sign-in:",e),!1}return!0},jwt:async({token:e,user:r,account:s})=>(r&&(e.role=r.role),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.sub,e.user.role=r.role),e)},pages:{signIn:"/auth/signin"},session:{strategy:"jwt",maxAge:2592e3},jwt:{maxAge:2592e3},secret:"development-secret-key-for-local-testing-only"}},72331:(e,r,s)=>{s.d(r,{_:()=>i});var t=s(53524);let i=globalThis.prisma??new t.PrismaClient}};var r=require("../../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[276,972,23,734],()=>s(96068));module.exports=t})();